&НаКлиенте
Процедура КнопкаОКНажатие(Команда)
    // Проверяем, есть ли данные в таблице
    Если ТаблицаКлючей.Количество() = 0 Тогда
        Сообщить("Не введено ни одного ключа. Операция отменена.");
        Возврат;
    КонецЕсли;

    // Обрабатываем ключи
    Для Каждого Строка Из ТаблицаКлючей Цикл
        Если ПустаяСтрока(Строка.Ключ) Тогда
            Сообщить("Один из ключей не заполнен. Операция отменена.");
            Возврат;
        КонецЕсли;

        // Вызываем серверную процедуру для распечатки хранилища
        РаспечататьХранилище(Строка.Ключ);
    КонецЦикла;

    Сообщить("Все ключи успешно обработаны.");
    Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура КнопкаЗакрытьНажатие(Команда)
    Закрыть();
КонецПроцедуры

&НаСервере
Процедура РаспечататьХранилище(Ключ)
    // Получаем значения из констант
    АдресХранилища = Константы.АдресХранилища.Получить();
    ПортХранилища = Константы.ПортХранилища.Получить();
    Токен = Константы.ТокенVault.Получить();

    Если ПустаяСтрока(АдресХранилища) Тогда
        Сообщить("Ошибка: не задан адрес сервера в константе.");
        Возврат;
    КонецЕсли;

    Если ПустаяСтрока(Токен) Тогда
        Сообщить("Ошибка: не задан токен в константе.");
        Возврат;
    КонецЕсли;

    // Настраиваем параметры запроса
    URL = "/v1/sys/unseal";
    Соединение = Новый HTTPСоединение(АдресХранилища, Число(ПортХранилища));

    // Заголовки запроса
    Заголовки = Новый Соответствие();
    Заголовки.Вставить("X-Vault-Token", Токен);

    // Формируем данные запроса
    Данные = "{""key"":""" + Ключ + """}";
    HTTPЗапрос = Новый HTTPЗапрос(URL, Заголовки);
    HTTPЗапрос.УстановитьТелоИзСтроки(Данные);
    
    Попытка
        // Выполняем запрос
        Ответ = Соединение.ВызватьHTTPМетод("POST", HTTPЗапрос);

        // Обрабатываем ответ
        Если Ответ.КодСостояния = 200 Тогда
            Сообщить("Ключ успешно применён: " + Ключ);
        Иначе
            Сообщить("Ошибка применения ключа: " + Ответ.КодСостояния + " " + Ответ.ПолучитьТелоКакСтроку());
        КонецЕсли;
    Исключение
        // Обработка ошибки
        Сообщить("Ошибка выполнения запроса с ключом " + Ключ + ": " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры
